/*!
 * Cropper v0.1.0
 * https://github.com/fengyuanchen/cropper
 *
 * Copyright 2014 Fengyuan Chen
 * Released under the MIT license
 */

!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a(jQuery)}(function(a){"use strict";var b=a(document),c=function(b,d){d=a.isPlainObject(d)?d:{},this.$element=a(b),this.defaults=a.extend({},c.defaults,this.$element.data(),d),this.init()};c.prototype={construstor:c,init:function(){var a=this.defaults.aspectRatio;this.defaults.aspectRatio="number"==typeof a&&a>0?a:1,this.enable()},enable:function(b){var d=this.$element;if(!this.active){if(b=b||d.prop("src"),!b)throw new Error("Invalid image!");this.url=b,this.$cropper=a(c.template),this.$dragger=this.$cropper.find(".cropper-dragger"),c.fn.toggle(d),d.after(this.$cropper),this.defaults.modal||c.fn.toggle(this.$cropper.find(".cropper-modal")),this.setPreview(),this.setImage(),this.addListener(),this.active=!0}},disable:function(){this.active&&(this.removeListener(),this.$cropper.empty().remove(),c.fn.toggle(this.$element),this.$cropper=null,this.$dragger=null,this.$preview=null,this.cropper=null,this.dragger=null,this.image=null,this.url="",this.active=!1)},addListener:function(){this.$element.on("load",a.proxy(this.load,this)),this.$dragger.on("mousedown",a.proxy(this.mousedown,this)),b.on("mousemove",a.proxy(this.mousemove,this)),b.on("mouseup",a.proxy(this.mouseup,this))},removeListener:function(){this.$element.off("load",this.load),this.$dragger.off("mousedown",this.mousedown),b.off("mousemove",this.mousemove),b.off("mouseup",this.mouseup)},load:function(){var a;return this.active?(a=this.$element.prop("src"),void(a&&a!==this.url&&(this.destory(),this.enable(a)))):void this.enable()},mousedown:function(b){var c=a(b.target).data().resize;"string"==typeof c&&c.length>0&&(this.mouseX1=b.clientX,this.mouseY1=b.clientY,this.resize=c)},mousemove:function(a){this.resize&&(this.mouseX2=a.clientX,this.mouseY2=a.clientY,this.resizing())},mouseup:function(){this.resize=""},setImage:function(){var b=this,d=a('<img src="'+this.url+'">');d.on("load",function(){var d,e=a(this);this.naturalWidth&&this.naturalHeight?d={naturalHeight:this.naturalHeight,naturalWidth:this.naturalWidth}:(c.fn.size(e,{height:"auto",width:"auto"}),d=c.fn.size(e),d={naturalHeight:d.height,naturalWidth:d.width}),c.fn.size(e,{height:"100%",width:"100%"}),b.image=d,b.setCropper()}),this.$cropper.prepend(d)},setPreview:function(){var a=this.defaults.preview;this.$preview=this.$cropper.find(".cropper-preview"),"string"==typeof a&&a.length>0&&(this.$preview=this.$preview.add(a)),this.$preview.html('<img src="'+this.url+'">')},setCropper:function(){var b,d=this.$element.parent(),e=c.fn.size(d),f=this.image;f.naturalWidth*e.height/f.naturalHeight-e.width>=0?(b={height:e.width*f.naturalHeight/f.naturalWidth,width:e.width,left:0},b.top=(e.height-b.height)/2):(b={height:e.height,width:e.height*f.naturalWidth/f.naturalHeight,top:0},b.left=(e.width-b.width)/2),a.each(b,function(a,c){b[a]=Math.round(c)}),f.height=b.height,f.width=b.width,c.fn.position(d),this.$cropper.css({height:b.height,left:b.left,top:b.top,width:b.width}),this.cropper=b,this.setDragger()},setDragger:function(){var a,b=this.cropper,d=this.defaults.aspectRatio;a=b.height*d-b.width>=0?{height:b.width/d,width:b.width,left:0,top:(b.height-b.width/d)/2,maxWidth:b.width,maxHeight:b.width/d}:{height:b.height,width:b.height*d,left:(b.width-b.height*d)/2,top:0,maxHeight:b.height,maxWidth:b.height*d},a.height*=.8,a.width*=.8,a.left=(b.width-a.width)/2,a.top=(b.height-a.height)/2,this.dragger=c.fn.round(a),this.resetDragger()},resetDragger:function(){var a=this.dragger,b=this.cropper;a.width=a.width>a.maxWidth?a.maxWidth:Math.abs(a.width),a.height=a.height>a.maxHeight?a.maxHeight:Math.abs(a.height),a.maxLeft=b.width-a.width,a.maxTop=b.height-a.height,a.left=a.left<0?0:a.left>a.maxLeft?a.maxLeft:a.left,a.top=a.top<0?0:a.top>a.maxTop?a.maxTop:a.top,a=c.fn.round(a),this.$dragger.css({height:a.height,left:a.left,top:a.top,width:a.width}),this.preview(),this.output()},resizing:function(){var a=this.resize,b=this.dragger,c=this.defaults.aspectRatio,d={x:this.mouseX2-this.mouseX1,y:this.mouseY2-this.mouseY1};switch(d.X=d.y*c,d.Y=d.x/c,a){case"e":b.width+=d.x,b.height=b.width/c,b.top-=d.Y/2,this.resize=b.width<0?"w":a;break;case"n":b.height-=d.y,b.width=b.height*c,b.left+=d.X/2,b.top+=d.y,this.resize=b.height<0?"s":a;break;case"w":b.width-=d.x,b.height=b.width/c,b.left+=d.x,b.top+=d.Y/2,this.resize=b.width<0?"e":a;break;case"s":b.height+=d.y,b.width=b.height*c,b.left-=d.X/2,this.resize=b.height<0?"n":a;break;case"ne":b.height-=d.y,b.width=b.height*c,b.top+=d.y,this.resize=b.height<0?"sw":a;break;case"nw":b.height-=d.y,b.width=b.height*c,b.left+=d.X,b.top+=d.y,this.resize=b.height<0?"se":a;break;case"sw":b.width-=d.x,b.height=b.width/c,b.left+=d.x,this.resize=b.width<0?"ne":a;break;case"se":b.width+=d.x,b.height=b.width/c,this.resize=b.width<0?"nw":a;break;default:b.left+=this.mouseX2-this.mouseX1,b.top+=this.mouseY2-this.mouseY1}this.resetDragger(),this.mouseX1=this.mouseX2,this.mouseY1=this.mouseY2},output:function(){var a=this.image.width/this.image.naturalWidth,b=this.dragger,d={x1:b.left,y1:b.top,x2:b.left+b.width,y2:b.top+b.height,height:b.height,width:b.width};d=c.fn.round(d,function(b){return b/a}),this.defaults.done(d)},preview:function(){var b=this;this.$preview.each(function(){var d=a(this),e=b.cropper,f=b.dragger,g=d.width()/f.width,h={height:e.height,marginLeft:-f.left,marginTop:-f.top,width:e.width};h=c.fn.round(h,function(a){return a*g}),d.css({overflow:"hidden"}),d.find("img").css(h)})}},c.fn={toggle:function(a){a.toggleClass("cropper-hidden")},position:function(a,b){var c=a.css("position");"static"===c&&a.css("position",b||"relative")},size:function(b,c){return a.isPlainObject(c)?void b.css(c):{height:b.height(),width:b.width()}},round:function(b,c){var d,e;for(e in b)d=b[e],b.hasOwnProperty(e)&&"number"==typeof d&&(b[e]=Math.round(a.isFunction(c)?c(d):d));return b}},c.template=['<div class="cropper-container">','<div class="cropper-modal"></div>','<div class="cropper-dragger">','<span class="cropper-preview"></span>','<span class="cropper-dashed dashed-h"></span>','<span class="cropper-dashed dashed-v"></span>','<span class="cropper-face" data-resize="*"></span>','<span class="cropper-line line-e" data-resize="e"></span>','<span class="cropper-line line-n" data-resize="n"></span>','<span class="cropper-line line-w" data-resize="w"></span>','<span class="cropper-line line-s" data-resize="s"></span>','<span class="cropper-point point-e" data-resize="e"></span>','<span class="cropper-point point-n" data-resize="n"></span>','<span class="cropper-point point-w" data-resize="w"></span>','<span class="cropper-point point-s" data-resize="s"></span>','<span class="cropper-point point-ne" data-resize="ne"></span>','<span class="cropper-point point-nw" data-resize="nw"></span>','<span class="cropper-point point-sw" data-resize="sw"></span>','<span class="cropper-point point-se" data-resize="se"></span>',"</div>","</div>"].join(""),c.defaults={aspectRatio:1,done:function(){},modal:!0,preview:""},c.setDefaults=function(b){a.extend(c.defaults,b)},a.fn.cropper=function(b){return this.each(function(){a(this).data("cropper",new c(this,b))})},a.fn.cropper.Constructor=c,a.fn.cropper.setDefaults=c.setDefaults,a(function(){a("[cropper]").cropper()})});