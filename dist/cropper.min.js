/*!
 * Cropper v0.1.0
 * https://github.com/fengyuanchen/cropper
 *
 * Copyright 2014 Fengyuan Chen
 * Released under the MIT license
 */

(function(e){if(typeof define==="function"&&define.amd){define(["jquery"],e)}else{e(jQuery)}})(function(e){"use strict";var t=e(document),n=function(t,r){r=e.isPlainObject(r)?r:{};this.$element=e(t);this.defaults=e.extend({},n.defaults,this.$element.data(),r);this.init()};n.prototype={construstor:n,init:function(){var e=this.defaults.aspectRatio;if(e!==false){e=typeof e!=="number"?parseInt(e,10):e;this.defaults.aspectRatio=e&&e>0?e:1}this.enable()},enable:function(t){var r=this.$element;if(this.active){return}t=t||r.prop("src");if(!t){throw new Error("Invalid image!")}this.url=t;this.$cropper=e(n.template);this.$dragger=this.$cropper.find(".cropper-dragger");n.fn.toggle(r);r.after(this.$cropper);if(!this.defaults.modal){n.fn.toggle(this.$cropper.find(".cropper-modal"))}this.setPreview();this.setImage();this.addListener();this.active=true},disable:function(){if(!this.active){return}this.removeListener();this.$cropper.empty().remove();n.fn.toggle(this.$element);this.$cropper=null;this.$dragger=null;this.$preview=null;this.cropper=null;this.dragger=null;this.image=null;this.url="";this.active=false},addListener:function(){this.$element.on("load",e.proxy(this.load,this));this.$dragger.on("mousedown",e.proxy(this.mousedown,this));t.on("mousemove",e.proxy(this.mousemove,this));t.on("mouseup",e.proxy(this.mouseup,this))},removeListener:function(){this.$element.off("load",this.load);this.$dragger.off("mousedown",this.mousedown);t.off("mousemove",this.mousemove);t.off("mouseup",this.mouseup)},load:function(){var e;if(this.active){e=this.$element.prop("src");if(e&&e!==this.url){this.disable();this.enable(e)}return}this.enable()},mousedown:function(t){var n=e(t.target).data().direction;if(typeof n==="string"&&n.length>0){this.mouseX1=t.clientX;this.mouseY1=t.clientY;this.direction=n}},mousemove:function(e){if(this.direction){this.mouseX2=e.clientX;this.mouseY2=e.clientY;this.dragging()}},mouseup:function(){this.direction=""},setImage:function(){var t=this,r=e('<img src="'+this.url+'">');r.on("load",function(){var r=e(this),i;if(this.naturalWidth&&this.naturalHeight){i={naturalHeight:this.naturalHeight,naturalWidth:this.naturalWidth}}else{n.fn.size(r,{height:"auto",width:"auto"});i=n.fn.size(r);i={naturalHeight:i.height,naturalWidth:i.width}}n.fn.size(r,{height:"100%",width:"100%"});t.image=i;t.setCropper()});this.$cropper.prepend(r)},setPreview:function(){var e=this.defaults.preview;this.$preview=this.$cropper.find(".cropper-preview");if(typeof e==="string"&&e.length>0){this.$preview=this.$preview.add(e)}this.$preview.html('<img src="'+this.url+'">')},setCropper:function(){var t=this.$element.parent(),r=n.fn.size(t),i=this.image,s;if(i.naturalWidth*r.height/i.naturalHeight-r.width>=0){s={height:r.width*i.naturalHeight/i.naturalWidth,width:r.width,left:0};s.top=(r.height-s.height)/2}else{s={height:r.height,width:r.height*i.naturalWidth/i.naturalHeight,top:0};s.left=(r.width-s.width)/2}e.each(s,function(e,t){s[e]=Math.round(t)});i.height=s.height;i.width=s.width;i.ratio=i.width/i.naturalWidth;n.fn.position(t);this.$cropper.css({height:s.height,left:s.left,top:s.top,width:s.width});this.cropper=s;this.setDragger()},setDragger:function(){var e=this.cropper,t=this.defaults.aspectRatio||this.image.naturalWidth/this.image.naturalHeight,r;if(e.height*t-e.width>=0){r={height:e.width/t,width:e.width,left:0,top:(e.height-e.width/t)/2,maxWidth:e.width,maxHeight:e.width/t}}else{r={height:e.height,width:e.height*t,left:(e.width-e.height*t)/2,top:0,maxHeight:e.height,maxWidth:e.height*t}}r.height*=.8;r.width*=.8;r.left=(e.width-r.width)/2;r.top=(e.height-r.height)/2;this.dragger=n.fn.round(r);this.resetDragger()},resetDragger:function(){var e=this.dragger,t=this.cropper;e.width=e.width>e.maxWidth?e.maxWidth:Math.abs(e.width);e.height=e.height>e.maxHeight?e.maxHeight:Math.abs(e.height);e.maxLeft=t.width-e.width;e.maxTop=t.height-e.height;e.left=e.left<0?0:e.left>e.maxLeft?e.maxLeft:e.left;e.top=e.top<0?0:e.top>e.maxTop?e.maxTop:e.top;e=n.fn.round(e);this.$dragger.css({height:e.height,left:e.left,top:e.top,width:e.width});this.dragger=e;this.preview();this.output()},dragging:function(){var e=this.direction,t=this.dragger,n=this.defaults.aspectRatio,r={x:this.mouseX2-this.mouseX1,y:this.mouseY2-this.mouseY1};if(n){r.X=r.y*n;r.Y=r.x/n}switch(e){case"e":t.width+=r.x;if(n){t.height=t.width/n;t.top-=r.Y/2}if(t.width<0){this.direction="w";t.width=0}break;case"n":t.height-=r.y;t.top+=r.y;if(n){t.width=t.height*n;t.left+=r.X/2}if(t.height<0){this.direction="s";t.height=0}break;case"w":t.width-=r.x;t.left+=r.x;if(n){t.height=t.width/n;t.top+=r.Y/2}if(t.width<0){this.direction="e";t.width=0}break;case"s":t.height+=r.y;if(n){t.width=t.height*n;t.left-=r.X/2}if(t.height<0){this.direction="n";t.height=0}break;case"ne":t.height-=r.y;t.top+=r.y;if(n){t.width=t.height*n}else{t.width+=r.x}if(t.height<0){this.direction="sw";t.height=0;t.width=0}break;case"nw":t.height-=r.y;t.top+=r.y;if(n){t.width=t.height*n;t.left+=r.X}else{t.width-=r.x;t.left+=r.x}if(t.height<0){this.direction="se";t.height=0;t.width=0}break;case"sw":t.width-=r.x;t.left+=r.x;if(n){t.height=t.width/n}else{t.height+=r.y}if(t.width<0){this.direction="ne";t.height=0;t.width=0}break;case"se":t.width+=r.x;if(n){t.height=t.width/n}else{t.height+=r.y}if(t.width<0){this.direction="nw";t.height=0;t.width=0}break;default:t.left+=r.x;t.top+=r.y}this.resetDragger();this.mouseX1=this.mouseX2;this.mouseY1=this.mouseY2},output:function(){var e=this.image.ratio,t=this.dragger,r={x1:t.left,y1:t.top,x2:t.left+t.width,y2:t.top+t.height,height:t.height,width:t.width,image:this.image};this.defaults.done(n.fn.round(r,function(t){return t/e}))},preview:function(){var t=this,r=t.cropper,i=t.dragger;this.$preview.each(function(){var t=e(this),s=t.outerWidth()/i.width,o={height:r.height,marginLeft:-i.left,marginTop:-i.top,width:r.width};t.css({overflow:"hidden"});t.find("img").css(n.fn.round(o,function(e){return e*s}))})}};n.fn={toggle:function(e){e.toggleClass("cropper-hidden")},position:function(e,t){var n=e.css("position");if(n==="static"){e.css("position",t||"relative")}},size:function(t,n){if(e.isPlainObject(n)){t.css(n)}else{return{height:t.height(),width:t.width()}}},round:function(t,n){var r,i;for(i in t){r=t[i];if(t.hasOwnProperty(i)&&typeof r==="number"){t[i]=Math.round(e.isFunction(n)?n(r):r)}}return t}};n.template=['<div class="cropper-container">','<div class="cropper-modal"></div>','<div class="cropper-dragger">','<span class="cropper-preview"></span>','<span class="cropper-dashed dashed-h"></span>','<span class="cropper-dashed dashed-v"></span>','<span class="cropper-face" data-direction="*"></span>','<span class="cropper-line line-e" data-direction="e"></span>','<span class="cropper-line line-n" data-direction="n"></span>','<span class="cropper-line line-w" data-direction="w"></span>','<span class="cropper-line line-s" data-direction="s"></span>','<span class="cropper-point point-e" data-direction="e"></span>','<span class="cropper-point point-n" data-direction="n"></span>','<span class="cropper-point point-w" data-direction="w"></span>','<span class="cropper-point point-s" data-direction="s"></span>','<span class="cropper-point point-ne" data-direction="ne"></span>','<span class="cropper-point point-nw" data-direction="nw"></span>','<span class="cropper-point point-sw" data-direction="sw"></span>','<span class="cropper-point point-se" data-direction="se"></span>',"</div>","</div>"].join("");n.defaults={aspectRatio:1,done:function(){},modal:true,preview:""};n.setDefaults=function(t){e.extend(n.defaults,t)};e.fn.cropper=function(t){return this.each(function(){var r=e(this),i=r.data("cropper");if(!i){i=new n(this,t);r.data("cropper",i)}if(typeof t==="string"&&e.isFunction(i[t])){i[t]()}})};e.fn.cropper.Constructor=n;e.fn.cropper.setDefaults=n.setDefaults;e(function(){e("img[cropper]").cropper()})})
